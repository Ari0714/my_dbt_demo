

-- models/step_by_step_temp_view.sql
{{
  config(
    materialized = 'table'
  )
}}

-- æ­¥éª¤1: åˆ›å»ºä¸´æ—¶è§†å›¾
{% set create_view_sql %}
    CREATE OR REPLACE TEMPORARY VIEW temp_product_stats AS (
        SELECT
            product_id,
            category,
            COUNT(DISTINCT user_id) as unique_buyers,
            SUM(quantity) as total_quantity,
            SUM(amount) as total_revenue,
            AVG(rating) as avg_rating
        FROM {{ ref('sales') }} s
        JOIN {{ ref('products') }} p ON s.product_id = p.id
        WHERE s.sale_date >= CURRENT_DATE - 90
        GROUP BY product_id, category
    )
{% endset %}

{% do run_query(create_view_sql) %}

-- æ­¥éª¤2: ä½¿ç”¨ä¸´æ—¶è§†å›¾è¿›è¡Œå¤æ‚æŸ¥è¯¢
SELECT
    p.product_name,
    p.category,
    s.unique_buyers,
    s.total_quantity,
    s.total_revenue,
    s.avg_rating,
    -- è®¡ç®—è¡ç”ŸæŒ‡æ ‡
    s.total_revenue / NULLIF(s.unique_buyers, 0) as revenue_per_buyer,
    s.total_quantity / NULLIF(s.unique_buyers, 0) as quantity_per_buyer,
    -- åˆ†ç±»é€»è¾‘
    CASE
        WHEN s.avg_rating >= 4.5 THEN 'Top Rated'
        WHEN s.avg_rating >= 4.0 THEN 'Highly Rated'
        ELSE 'Standard'
    END as rating_category
FROM temp_product_stats s
JOIN {{ ref('products') }} p ON s.product_id = p.id
WHERE s.total_revenue > 1000
ORDER BY s.total_revenue DESC


-------
{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 1 AS id, 'Alice' AS name
    UNION ALL
    SELECT 2 AS id, 'Bob' AS name
),
final_data AS (
    SELECT * FROM source_data
    UNION ALL
    SELECT NULL AS id, NULL AS name
    WHERE NOT EXISTS (SELECT 1 FROM source_data)
)

SELECT
    {{ select_with_target_columns_from_list(
        ['id','name'],  -- æºåˆ—
        this,           -- å½“å‰ç›®æ ‡è¡¨
        "'UNKNOWN'"     -- ç¼ºåˆ—é»˜è®¤å€¼
    ) }}
FROM final_data



macros/select_with_target_columns_from_list.sql
{% macro select_with_target_columns_from_list(src_cols, target_relation, default_value="'UNKNOWN'") %}
{#
    src_cols: list, æºåˆ—åï¼Œä¾‹å¦‚ ['id','name']
    target_relation: this, å½“å‰æ¨¡å‹ç›®æ ‡è¡¨
    default_value: ç›®æ ‡è¡¨ç¼ºåˆ—é»˜è®¤å€¼ï¼Œä¾‹å¦‚ "'UNKNOWN'"
#}

{# è·å–ç›®æ ‡è¡¨åˆ—ä¿¡æ¯ #}
{% set tgt_cols = adapter.get_columns_in_relation(target_relation) %}
{% set tgt_col_names = tgt_cols | map(attribute='name') | list %}

{# æ„å»º SELECT åˆ—åˆ—è¡¨ #}
{% set select_list = [] %}

{% for col in tgt_col_names %}
    {% if col in src_cols %}
        {% do select_list.append(col) %}
    {% else %}
        {% do select_list.append(default_value ~ " AS " ~ col) %}
    {% endif %}
{% endfor %}

{{ select_list | join(', ') }}
{% endmacro %}



------------
macros/select_with_manifest_columns.sql
{% macro select_with_manifest_columns(ephemeral_model_name, target_relation, default_value="'UNKNOWN'") %}
    {#
        ephemeral_model_name: æ¨¡å‹æ–‡ä»¶åï¼Œä¾‹å¦‚ 'model_a'
        target_relation: å½“å‰æ¨¡å‹ this
        default_value: ç›®æ ‡è¡¨ç¼ºåˆ—é»˜è®¤å€¼
    #}

    {# è·å– manifest å¯¹è±¡ä¸­èŠ‚ç‚¹ä¿¡æ¯ #}
    {% set node = graph.get_node(ephemeral_model_name) %}

    {# è·å– ephemeral æºåˆ—åˆ—è¡¨ #}
    {% set src_cols = node.columns.keys() %}

    {# è·å–ç›®æ ‡è¡¨åˆ— #}
    {% set tgt_cols = adapter.get_columns_in_relation(target_relation) %}
    {% set tgt_col_names = tgt_cols | map(attribute='name') | list %}

    {# ç”Ÿæˆ SELECT åˆ—ï¼Œæºåˆ—ä¿æŒåŸå€¼ï¼Œç¼ºåˆ—è¡¥é»˜è®¤å€¼ #}
    {% set select_list = [] %}

    {% for col in tgt_col_names %}
        {% if col in src_cols %}
            {% do select_list.append(col) %}
        {% else %}
            {% do select_list.append(default_value ~ " AS " ~ col) %}
        {% endif %}
    {% endfor %}

    {{ select_list | join(', ') }}
{% endmacro %}


-------

{{ log("DEBUG: columns = " ~ select_with_target_columns(ref('stg_user'), this), info=True) }}



macros/select_with_target_columns.sql
{% macro select_with_target_columns(source_relation, target_relation) %}
{# ========================================================
è‡ªåŠ¨ç”Ÿæˆ SELECT åˆ—åˆ—è¡¨ï¼š
- æºè¡¨å·²æœ‰åˆ—ç›´æ¥ä½¿ç”¨
- ç›®æ ‡è¡¨ç¼ºåˆ—è‡ªåŠ¨è¡¥ NULL AS col
- å¯ç”¨äº dbt æ¨¡å‹æ›¿ä»£åˆ—åˆ—è¡¨
======================================================== #}

{# è·å–æºè¡¨åˆ—ä¿¡æ¯ #}
{% set src_cols = adapter.get_columns_in_relation(source_relation) %}
{% if src_cols is none %}
    {{ exceptions.raise_compiler_error("æ— æ³•è·å–æºè¡¨åˆ—: " ~ source_relation) }}
{% endif %}

{% set src_names = [] %}
{% for col in src_cols %}
    {% do src_names.append(col.name|string) %}
{% endfor %}

{# è·å–ç›®æ ‡è¡¨åˆ—ä¿¡æ¯ #}
{% set tgt_cols = adapter.get_columns_in_relation(target_relation) %}
{% if tgt_cols is none %}
    {{ exceptions.raise_compiler_error("æ— æ³•è·å–ç›®æ ‡è¡¨åˆ—: " ~ target_relation) }}
{% endif %}

{% set tgt_names = [] %}
{% for col in tgt_cols %}
    {% do tgt_names.append(col.name|string) %}
{% endfor %}

{# ç”Ÿæˆ SELECT åˆ—åˆ—è¡¨ #}
{% set select_list = [] %}
{% for col in tgt_names %}
    {% if col in src_names %}
        {% do select_list.append(col) %}
    {% else %}
        {% do select_list.append("NULL AS " ~ col) %}
    {% endif %}
{% endfor %}

{{ select_list | join(',\n  ') }}
{% endmacro %}

-- models/stg_user.sql
SELECT
  {{ select_with_target_columns(ref('stg_user'), this) }}
FROM {{ ref('stg_user') }}



------

+pre-hook: "{{ auto_schema_align_prehook() }}"



{% macro auto_schema_align_prehook() %}
{# =========================================================
å®Œå…¨è‡ªåŠ¨ pre-hook + schema å¯¹é½å®
é€‚ç”¨äº Spark + Iceberg
- è‡ªåŠ¨å¼€å¯ merge-schema
- æ‰“å°æºè¡¨ä¸ç›®æ ‡è¡¨åˆ—å·®å¼‚
- ä¸ä¿®æ”¹æ¨¡å‹ SQL
- ä¸ä¿®æ”¹ç›®æ ‡è¡¨ç»“æ„
========================================================= #}

{# å½“å‰æ¨¡å‹ relation #}
{% set model_relation = this %}

{{ log("ğŸ”§ Auto Schema Align Pre-Hook for model: " ~ model_relation, info=True) }}

{# 1ï¸âƒ£ å¯ç”¨ Spark merge-schema å’Œ Iceberg è‡ªåŠ¨è¿ç§» #}
{% do run_query("SET spark.sql.iceberg.merge-schema=true") %}
{% do run_query("SET spark.sql.iceberg.schema.auto-migration.enabled=true") %}
{% do run_query("SET spark.sql.sources.partitionOverwriteMode=dynamic") %}

{# 2ï¸âƒ£ è·å–æºè¡¨åˆ—ä¿¡æ¯ #}
{% set src_cols = adapter.get_columns_in_relation(model_relation) %}
{% if src_cols is none %}
    {{ log("âš ï¸ æ— æ³•è·å–æºè¡¨åˆ—ä¿¡æ¯", info=True) }}
{% else %}
    {% set src_names = [] %}
    {% for col in src_cols %}
        {% do src_names.append(col.name|string) %}
    {% endfor %}
{% endif %}

{# 3ï¸âƒ£ è·å–ç›®æ ‡è¡¨åˆ—ä¿¡æ¯ #}
{% set tgt_cols = adapter.get_columns_in_relation(model_relation) %}
{% if tgt_cols is none %}
    {{ log("âš ï¸ ç›®æ ‡è¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è·å–åˆ—ä¿¡æ¯ï¼Œmerge-schema ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨", info=True) }}
{% else %}
    {% set tgt_names = [] %}
    {% for col in tgt_cols %}
        {% do tgt_names.append(col.name|string) %}
    {% endfor %}

    {# 4ï¸âƒ£ è®¡ç®—ç¼ºåˆ—å’Œå¤šä½™åˆ—ï¼ˆå®‰å…¨å†™æ³•ï¼Œä¸ç”¨ differenceã€rejectï¼‰ #}
    {% set missing_cols = [] %}
    {% for col in tgt_names %}
        {% if col not in src_names %}
            {% do missing_cols.append(col) %}
        {% endif %}
    {% endfor %}

    {% set extra_cols = [] %}
    {% for col in src_names %}
        {% if col not in tgt_names %}
            {% do extra_cols.append(col) %}
        {% endif %}
    {% endfor %}

    {# 5ï¸âƒ£ æ‰“å°æ—¥å¿— #}
    {% if missing_cols | length > 0 %}
        {{ log("âš ï¸ æ¨¡å‹ç¼ºå°‘ç›®æ ‡åˆ—ï¼Œå°†å†™å…¥æ—¶è‡ªåŠ¨è¡¥ NULL: " ~ (missing_cols | join(', ')), info=True) }}
    {% endif %}
    {% if extra_cols | length > 0 %}
        {{ log("âš ï¸ æ¨¡å‹å­˜åœ¨å¤šä½™åˆ—ï¼Œå°†è¢«å¿½ç•¥: " ~ (extra_cols | join(', ')), info=True) }}
    {% endif %}
{% endif %}

{% endmacro %}



macros/auto_schema_align_prehook.sql
{% macro auto_schema_align_prehook() %}
{#
å®Œå…¨è‡ªåŠ¨ pre-hook + schema å¯¹é½å®
- ä½¿ç”¨ Spark + Iceberg merge-schema è‡ªåŠ¨è¡¥ç¼ºåˆ—
- æ‰“å°æ—¥å¿—
- ä¸æ”¹æ¨¡å‹ SQL
#}

{# å½“å‰æ¨¡å‹ relation #}
{% set model_relation = this %}

{# å¯ç”¨ Spark merge-schema å’Œ Iceberg è‡ªåŠ¨è¿ç§» #}
{% do run_query("SET spark.sql.iceberg.merge-schema=true") %}
{% do run_query("SET spark.sql.iceberg.schema.auto-migration.enabled=true") %}
{% do run_query("SET spark.sql.sources.partitionOverwriteMode=dynamic") %}

{# æ‰“å°å½“å‰æ¨¡å‹ &ç›®æ ‡è¡¨ä¿¡æ¯ #}
{{ log("ğŸ”§ Auto Schema Align: " ~ model_relation, info=True) }}

{# è·å–æºè¡¨ columns #}
{% set src_cols = adapter.get_columns_in_relation(model_relation) %}
{% if src_cols is none %}
    {{ log("âš ï¸ æ— æ³•è·å–æºè¡¨åˆ—ä¿¡æ¯", info=True) }}
{% else %}
    {% set src_names = src_cols | map(attribute='name') | list %}
{% endif %}

{# è·å–ç›®æ ‡è¡¨ columnsï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œä¼šè¿”å› Noneï¼‰ #}
{% set tgt_cols = adapter.get_columns_in_relation(model_relation) %}
{% if tgt_cols is none %}
    {{ log("âš ï¸ ç›®æ ‡è¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è·å–åˆ—ä¿¡æ¯, merge-schema ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨", info=True) }}
{% else %}
    {% set tgt_names = tgt_cols | map(attribute='name') | list %}

    {# æ¯”è¾ƒå·®å¼‚ #}
    {% set missing_cols = tgt_names | difference(src_names) %}
    {% set extra_cols = src_names | difference(tgt_names) %}

    {% if missing_cols | length > 0 %}
        {{ log("âš ï¸ æ¨¡å‹ç¼ºå°‘ç›®æ ‡åˆ—ï¼Œå°†å†™å…¥æ—¶è‡ªåŠ¨è¡¥ NULL: " ~ (missing_cols | join(', ')), info=True) }}
    {% endif %}
    {% if extra_cols | length > 0 %}
        {{ log("âš ï¸ æ¨¡å‹å­˜åœ¨å¤šä½™åˆ—ï¼Œå°†è¢«å¿½ç•¥: " ~ (extra_cols | join(', ')), info=True) }}
    {% endif %}
{% endif %}
{% endmacro %}



----------

{{ config(
    materialized='incremental',
    options={
        "mergeSchema": "true"
    }
) }}


models:
  +file_format: iceberg
  +options:
      mergeSchema: true
  +pre-hook:
      - "SET spark.sql.iceberg.merge-schema=true"
      - "SET spark.sql.iceberg.schema.auto-migration.enabled=true"
      - "{{ log_schema_diff(this.name, 'analytics.user_profile') }}"


{% macro log_schema_diff(model_name, target_table) %}
  {% set src_cols = adapter.get_columns_in_relation(this) %}
  {% set tgt_cols = adapter.get_columns_in_relation(ref(target_table)) %}
  {% set src_names = src_cols | map(attribute='name') | list %}
  {% set tgt_names = tgt_cols | map(attribute='name') | list %}
  {% set missing_cols = tgt_names | difference(src_names) %}
  {% set extra_cols = src_names | difference(tgt_names) %}
  {% if missing_cols | length > 0 %}
    {{ log("âš ï¸ " ~ model_name ~ " ç¼ºåˆ— (ç›®æ ‡è¡¨å¤š): " ~ (missing_cols | join(', ')), info=True) }}
  {% endif %}
  {% if extra_cols | length > 0 %}
    {{ log("âš ï¸ " ~ model_name ~ " å¤šåˆ— (å°†å¿½ç•¥): " ~ (extra_cols | join(', ')), info=True) }}
  {% endif %}
{% endmacro %}



-----------------

{% do run_query("set spark.sql.iceberg.schema.autoMerge.enabled=true") %}


your_profile:
  target: dev
  outputs:
    dev:
      type: spark
      method: odbc
      host: your-spark-thrift-server
      ... # å…¶ä»–è¿æ¥é…ç½®
      config:
        spark.sql.extensions: org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
        spark.sql.catalog.your_catalog.merge-schema-on-write: true
        spark.sql.catalog.your_catalog.spark.sql.iceberg.merge-schema-on-write.enabled: true

outputs:
  dev:
    type: spark
    method: thrift
    ...
    schema: your_schema
    connect_retries: 5
    session_properties:
       spark.sql.iceberg.schema.autoMerge.enabled: true
